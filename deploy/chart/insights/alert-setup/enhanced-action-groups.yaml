apiVersion: v1
kind: ConfigMap
metadata:
  name: enhanced-action-groups-config
  namespace: banv-projects
data:
  create-enhanced-action-groups.sh: |
    #!/bin/bash

    # üöÄ ENHANCED ACTION GROUPS WITH AZURE MOBILE APP NOTIFICATIONS
    echo "üî• Creating ENHANCED Action Groups with Azure Mobile App push notifications..."

    RESOURCE_GROUP="mindx-individual-banv-rg"
    SUBSCRIPTION_ID="f244cdf7-5150-4b10-b3f2-d4bff23c5f45"

    # üì± CRITICAL ACTION GROUP - Mobile App + Email + Webhooks (P0 Priority)
    echo "üì± Creating CRITICAL Action Group with Azure Mobile App notifications..."
    az monitor action-group create \
      --name "banv-critical-alerts" \
      --resource-group "$RESOURCE_GROUP" \
      --short-name "BANVCrit" \
      --action email "BANV-Primary" "banv@mindx.com.vn" \
      --action azureapppush "Mobile-Critical-Alerts" "banv@mindx.com.vn" \
      --tags Environment=Production Service=BANV AlertType=Critical Priority=P0 MobileEnabled=true

    # ‚ö° HIGH PRIORITY ACTION GROUP - Mobile App + Email (P1 Priority)  
    echo "‚ö° Creating HIGH PRIORITY Action Group with Azure Mobile App notifications..."
    az monitor action-group create \
      --name "banv-high-priority-alerts" \
      --resource-group "$RESOURCE_GROUP" \
      --short-name "BANVHigh" \
      --action email "BANV-Primary" "banv@mindx.com.vn" \
      --action azureapppush "Mobile-High-Priority" "banv@mindx.com.vn" \
      --tags Environment=Production Service=BANV AlertType=HighPriority Priority=P1 MobileEnabled=true

    # ‚ö†Ô∏è WARNING ACTION GROUP - Email + Webhooks Only (No Mobile - P2/P3 Priority)  
    echo "‚ö†Ô∏è Creating WARNING Action Group (Email only - no mobile notifications)..."
    az monitor action-group create \
      --name "banv-warning-alerts" \
      --resource-group "$RESOURCE_GROUP" \
      --short-name "BANVWarn" \
      --action email "BANV-Primary" "banv@mindx.com.vn" \
      --tags Environment=Production Service=BANV AlertType=Warning Priority=P2P3 MobileEnabled=false

    # üìä BUSINESS ACTION GROUP - Email Only (No Mobile)
    echo "üìä Creating BUSINESS Action Group (Email only - business metrics)..."
    az monitor action-group create \
      --name "banv-business-alerts" \
      --resource-group "$RESOURCE_GROUP" \
      --short-name "BANVBiz" \
      --action email "BANV-Primary" "banv@mindx.com.vn" \
      --tags Environment=Production Service=BANV AlertType=Business Priority=P3 MobileEnabled=false

    # üîß INFRASTRUCTURE ACTION GROUP - Email Only (No Mobile for Infrastructure)
    echo "üîß Creating INFRASTRUCTURE Action Group (Email only)..."
    az monitor action-group create \
      --name "banv-infrastructure-alerts" \
      --resource-group "$RESOURCE_GROUP" \
      --short-name "BANVInfra" \
      --action email "BANV-Primary" "banv@mindx.com.vn" \
      --tags Environment=Production Service=BANV AlertType=Infrastructure Priority=P2 MobileEnabled=false

    # üéØ PERFORMANCE ACTION GROUP - High Priority Gets Mobile  
    echo "üéØ Creating PERFORMANCE Action Group (Mobile for critical performance issues)..."
    az monitor action-group create \
      --name "banv-performance-alerts" \
      --resource-group "$RESOURCE_GROUP" \
      --short-name "BANVPerf" \
      --action email "BANV-Primary" "banv@mindx.com.vn" \
      --action azureapppush "Mobile-Performance-Critical" "banv@mindx.com.vn" \
      --tags Environment=Production Service=BANV AlertType=Performance Priority=P1 MobileEnabled=true

    echo ""
    echo "üì± AZURE MOBILE APP NOTIFICATION SUMMARY:"
    echo "==========================================="
    echo "üìß Email Notifications: banv@mindx.com.vn (Your Outlook)"
    echo "üì± Mobile Notifications: Azure Mobile App (Your Microsoft Account)"
    echo ""
    echo "‚úÖ CRITICAL ALERTS (P0)    ‚Üí üì± Mobile App + üìß Outlook"
    echo "‚úÖ HIGH PRIORITY (P1)      ‚Üí üì± Mobile App + üìß Outlook"  
    echo "‚úÖ PERFORMANCE CRITICAL    ‚Üí üì± Mobile App + üìß Outlook"
    echo "üìß WARNING (P2)           ‚Üí üìß Outlook Only"
    echo "üìß BUSINESS (P3)          ‚Üí üìß Outlook Only"
    echo "üìß INFRASTRUCTURE (P2)    ‚Üí üìß Outlook Only"
    echo ""
    echo "üéØ Action Groups Summary:"
    echo "  üì± banv-critical-alerts      - Critical issues (MOBILE + EMAIL)"
    echo "  üì± banv-high-priority-alerts - High priority (MOBILE + EMAIL)"
    echo "  üì± banv-performance-alerts   - Critical performance (MOBILE + EMAIL)"
    echo "  üìß banv-warning-alerts       - Warning level (EMAIL only)"  
    echo "  üìß banv-business-alerts      - Business metrics (EMAIL only)"
    echo "  üìß banv-infrastructure-alerts - Infrastructure (EMAIL only)"
    echo ""
    echo "üî• CLEAN AZURE MOBILE APP + OUTLOOK ALERTING SYSTEM IS NOW LIVE!"
    echo "üì± Mobile App + üìß Outlook Email - No Slack distractions!"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: logging-based-azure-alerts-config
  namespace: banv-projects
data:
  create-logging-azure-alerts.sh: |
    #!/bin/bash

    # üöÄ LOGGING-BASED AZURE MONITOR ALERTS WITH MOBILE NOTIFICATIONS
    echo "üî• Creating Azure Monitor Alerts based on your new logging system..."

    RESOURCE_GROUP="mindx-individual-banv-rg"
    APP_INSIGHTS_ID="/subscriptions/f244cdf7-5150-4b10-b3f2-d4bff23c5f45/resourceGroups/mindx-individual-banv-rg/providers/microsoft.insights/components/mindx-banv-app-insights"

    # üì± CRITICAL ALERTS (Mobile Notifications Enabled)
    echo "üì± Creating CRITICAL logging-based alerts with mobile notifications..."

    # CRITICAL: High Error Rate from Request Logs (Mobile Alert)
    az monitor scheduled-query create \
      --name "CRITICAL-High-Request-Error-Rate-Mobile" \
      --resource-group "$RESOURCE_GROUP" \
      --scopes "$APP_INSIGHTS_ID" \
      --condition "count 'ErrorQuery' >= 1" \
      --condition-query ErrorQuery="requests | where timestamp > ago(5m) | where success == false | summarize ErrorRate = (count() * 100.0) / toscalar(requests | where timestamp > ago(5m) | count()) | where ErrorRate > 15" \
      --evaluation-frequency PT1M \
      --window-size PT5M \
      --severity 0 \
      --description "üö® CRITICAL MOBILE ALERT: Request error rate > 15% detected in Application Insights - Service degradation!" \
      --action-groups "/subscriptions/f244cdf7-5150-4b10-b3f2-d4bff23c5f45/resourceGroups/mindx-individual-banv-rg/providers/Microsoft.Insights/actionGroups/banv-critical-alerts"

    # CRITICAL: Security Events Detection (Mobile Alert)
    az monitor scheduled-query create \
      --name "CRITICAL-Security-Events-Mobile" \
      --resource-group "$RESOURCE_GROUP" \
      --scopes "$APP_INSIGHTS_ID" \
      --condition "count 'SecurityQuery' >= 1" \
      --condition-query SecurityQuery="customEvents | where timestamp > ago(10m) | where name == 'SecurityEvent' | where customDimensions.severity == 'critical' | summarize SecurityIncidents = count() | where SecurityIncidents > 0" \
      --evaluation-frequency PT1M \
      --window-size PT10M \
      --severity 0 \
      --description "üö® CRITICAL MOBILE ALERT: Security incidents detected! Unauthorized access attempts or critical security events occurred." \
      --action-groups "/subscriptions/f244cdf7-5150-4b10-b3f2-d4bff23c5f45/resourceGroups/mindx-individual-banv-rg/providers/Microsoft.Insights/actionGroups/banv-critical-alerts"

    # CRITICAL: Application Exceptions Spike (Mobile Alert)
    az monitor scheduled-query create \
      --name "CRITICAL-Application-Exceptions-Mobile" \
      --resource-group "$RESOURCE_GROUP" \
      --scopes "$APP_INSIGHTS_ID" \
      --condition "count 'ExceptionQuery' >= 1" \
      --condition-query ExceptionQuery="exceptions | where timestamp > ago(5m) | where customDimensions.logType == 'application' | summarize ExceptionCount = count() | where ExceptionCount > 10" \
      --evaluation-frequency PT1M \
      --window-size PT5M \
      --severity 0 \
      --description "üö® CRITICAL MOBILE ALERT: Application exception spike detected! More than 10 exceptions in 5 minutes indicates serious application issues." \
      --action-groups "/subscriptions/f244cdf7-5150-4b10-b3f2-d4bff23c5f45/resourceGroups/mindx-individual-banv-rg/providers/Microsoft.Insights/actionGroups/banv-critical-alerts"

    # ‚ö° HIGH PRIORITY ALERTS (Mobile Notifications Enabled)
    echo "‚ö° Creating HIGH PRIORITY logging-based alerts with mobile notifications..."

    # HIGH: Slow Request Performance (Mobile Alert)
    az monitor scheduled-query create \
      --name "HIGH-Slow-Request-Performance-Mobile" \
      --resource-group "$RESOURCE_GROUP" \
      --scopes "$APP_INSIGHTS_ID" \
      --condition "count 'SlowQuery' >= 1" \
      --condition-query SlowQuery="requests | where timestamp > ago(10m) | where duration > 2000 | summarize SlowRequests = count() | where SlowRequests > 5" \
      --evaluation-frequency PT2M \
      --window-size PT10M \
      --severity 1 \
      --description "‚ö° HIGH PRIORITY MOBILE ALERT: Multiple slow requests detected (>2s response time). User experience degradation!" \
      --action-groups "/subscriptions/f244cdf7-5150-4b10-b3f2-d4bff23c5f45/resourceGroups/mindx-individual-banv-rg/providers/Microsoft.Insights/actionGroups/banv-high-priority-alerts"

    # HIGH: Request Volume Drop (Mobile Alert)
    az monitor scheduled-query create \
      --name "HIGH-Request-Volume-Drop-Mobile" \
      --resource-group "$RESOURCE_GROUP" \
      --scopes "$APP_INSIGHTS_ID" \
      --condition "count 'VolumeQuery' >= 1" \
      --condition-query VolumeQuery="requests | where timestamp > ago(10m) | summarize RequestCount = count() | where RequestCount < 5" \
      --evaluation-frequency PT2M \
      --window-size PT10M \
      --severity 1 \
      --description "‚ö° HIGH PRIORITY MOBILE ALERT: Significant drop in request volume detected. Possible service outage or access issues!" \
      --action-groups "/subscriptions/f244cdf7-5150-4b10-b3f2-d4bff23c5f45/resourceGroups/mindx-individual-banv-rg/providers/Microsoft.Insights/actionGroups/banv-high-priority-alerts"

    # ‚ö†Ô∏è WARNING ALERTS (Email Only - No Mobile)
    echo "‚ö†Ô∏è Creating WARNING logging-based alerts (Email only)..."

    # WARNING: Increased Error Traces (Email Only)
    az monitor scheduled-query create \
      --name "WARNING-Increased-Error-Traces" \
      --resource-group "$RESOURCE_GROUP" \
      --scopes "$APP_INSIGHTS_ID" \
      --condition "count 'TraceQuery' >= 1" \
      --condition-query TraceQuery="traces | where timestamp > ago(15m) | where severityLevel >= 3 | where customDimensions.logType == 'application' | summarize ErrorTraces = count() | where ErrorTraces > 5" \
      --evaluation-frequency PT5M \
      --window-size PT15M \
      --severity 2 \
      --description "‚ö†Ô∏è WARNING: Increased error traces detected in application logs. Monitor for potential issues." \
      --action-groups "/subscriptions/f244cdf7-5150-4b10-b3f2-d4bff23c5f45/resourceGroups/mindx-individual-banv-rg/providers/Microsoft.Insights/actionGroups/banv-warning-alerts"

    # WARNING: Failed Login Attempts (Email Only)
    az monitor scheduled-query create \
      --name "WARNING-Failed-Login-Attempts" \
      --resource-group "$RESOURCE_GROUP" \
      --scopes "$APP_INSIGHTS_ID" \
      --condition "count 'LoginQuery' >= 1" \
      --condition-query LoginQuery="customEvents | where timestamp > ago(30m) | where name == 'SecurityEvent' | where customDimensions.severity in ('warning', 'medium') | summarize SecurityWarnings = count() | where SecurityWarnings > 10" \
      --evaluation-frequency PT5M \
      --window-size PT30M \
      --severity 2 \
      --description "‚ö†Ô∏è WARNING: Multiple failed login attempts or security warnings detected. Monitor for brute force attacks." \
      --action-groups "/subscriptions/f244cdf7-5150-4b10-b3f2-d4bff23c5f45/resourceGroups/mindx-individual-banv-rg/providers/Microsoft.Insights/actionGroups/banv-warning-alerts"

    echo ""
    echo "üì± LOGGING-BASED ALERTS WITH MOBILE NOTIFICATIONS SUMMARY:"
    echo "=========================================================="
    echo "üì± CRITICAL (Mobile + Email):"
    echo "   üö® High Request Error Rate (>15%)"
    echo "   üö® Security Events Detection" 
    echo "   üö® Application Exception Spike"
    echo ""
    echo "üì± HIGH PRIORITY (Mobile + Email):"
    echo "   ‚ö° Slow Request Performance (>2s)"
    echo "   ‚ö° Request Volume Drop"
    echo ""
    echo "üìß WARNING (Email Only):"
    echo "   ‚ö†Ô∏è Increased Error Traces"
    echo "   ‚ö†Ô∏è Failed Login Attempts"
    echo ""
    echo "üéØ Your Azure Mobile App will receive notifications for CRITICAL and HIGH PRIORITY issues only!"
    echo "üî• LOGGING-BASED MOBILE ALERTING SYSTEM IS READY!"
